# GitHub Workflow: Check Open-O
#
# Description:
# This workflow automates the build and testing for the Open-O Maven project.
# It uses a parallelized approach: build first, then run modern and legacy tests in parallel.
#
# Usage:
# - Triggered by pull requests targeting the following branches:
#   - main
#   - develop
#   - experimental
#
# Key Jobs:
# - build:
#   - Builds the dev container with Docker BuildKit caching
#   - Runs `make install` to verify the project builds successfully
#   - Caches Maven dependencies for subsequent jobs
#
# - modern-tests (parallel):
#   - Runs modern tests (JUnit 5) using H2 in-memory database
#   - Does NOT require the database container
#
# - legacy-tests (parallel):
#   - Runs legacy tests (JUnit 4) using MariaDB
#   - Requires the database container
#
# License:
# This GitHub Workflow file is part of the Open-O project and is subject
# to the licensing terms outlined in the repository's LICENSE file.
#
# Last Updated:
# January 2026

name: Check Open-O

on:
  pull_request:
    branches:
      - main
      - develop
      - experimental

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('.devcontainer/development/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: .m2-cache
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', '**/dependencies-lock*.json') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build dev container
        run: |
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t openo-tomcat-dev \
            .devcontainer/development
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Start container
        run: |
          docker run -d --name openo-tomcat-dev \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/.m2-cache:/root/.m2 \
            -w /workspace \
            openo-tomcat-dev tail -f /dev/null

      - name: Configure git safe directory
        run: |
          docker exec openo-tomcat-dev bash -c "
            git config --global --add safe.directory /workspace
          "

      - name: Build project (no tests)
        run: |
          docker exec openo-tomcat-dev bash -c "
            echo '========================================='
            echo 'Building project without tests'
            echo '========================================='
            make install
          "

  modern-tests:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('.devcontainer/development/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: .m2-cache
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', '**/dependencies-lock*.json') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build dev container (cached)
        run: |
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t openo-tomcat-dev \
            .devcontainer/development
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Start container
        run: |
          docker run -d --name openo-tomcat-dev \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/.m2-cache:/root/.m2 \
            -w /workspace \
            openo-tomcat-dev tail -f /dev/null

      - name: Configure git safe directory
        run: |
          docker exec openo-tomcat-dev bash -c "
            git config --global --add safe.directory /workspace
          "

      - name: Run modern tests
        run: |
          docker exec openo-tomcat-dev bash -c "
            echo '========================================='
            echo 'Running Modern Tests (JUnit 5 with H2)'
            echo '========================================='
            make install --run-modern-tests
          "

  legacy-tests:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers (tomcat)
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('.devcontainer/development/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Cache Docker layers (db)
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache-db
          key: ${{ runner.os }}-buildx-db-${{ hashFiles('.devcontainer/db/**', 'database/**') }}
          restore-keys: |
            ${{ runner.os }}-buildx-db-

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: .m2-cache
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml', '**/dependencies-lock*.json') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build dev container (cached)
        run: |
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            --load \
            -t openo-tomcat-dev \
            .devcontainer/development
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Build db container (cached)
        run: |
          docker buildx build \
            --cache-from=type=local,src=/tmp/.buildx-cache-db \
            --cache-to=type=local,dest=/tmp/.buildx-cache-db-new,mode=max \
            --load \
            -t openo-mariadb-dev \
            -f .devcontainer/db/Dockerfile .
          rm -rf /tmp/.buildx-cache-db
          mv /tmp/.buildx-cache-db-new /tmp/.buildx-cache-db

      - name: Create network
        run: docker network create open-o-network

      - name: Start db container
        run: |
          # Container named 'db' so it's reachable at jdbc:mysql://db:3306 from tomcat container
          docker run -d --name db \
            --network open-o-network \
            -e MYSQL_ROOT_PASSWORD=password \
            -e MYSQL_PASSWORD=password \
            -e TZ=America/Toronto \
            openo-mariadb-dev

      - name: Wait for db to be ready
        run: |
          echo "Waiting for MariaDB to accept connections..."
          connected=false
          for i in {1..30}; do
            if docker exec db mysqladmin ping -h localhost -u root -ppassword 2>/dev/null; then
              echo "MariaDB is accepting connections!"
              connected=true
              break
            fi
            echo "Waiting for connection... ($i/30)"
            sleep 2
          done

          if [ "$connected" != "true" ]; then
            echo "ERROR: MariaDB failed to accept connections within timeout"
            docker logs db
            exit 1
          fi

          echo "Waiting for database initialization to complete..."
          initialized=false
          for i in {1..90}; do
            # Check that provider table exists and has at least one row (indicates full initialization)
            count=$(docker exec db mysql -u root -ppassword -N -e "SELECT COUNT(*) FROM oscar.provider;" 2>/dev/null || echo "0")
            if [ "$count" -gt 0 ] 2>/dev/null; then
              echo "Database initialization complete! (provider count: $count)"
              initialized=true
              break
            fi
            echo "Waiting for database initialization... ($i/90)"
            sleep 2
          done

          if [ "$initialized" != "true" ]; then
            echo "ERROR: Database initialization failed within timeout"
            docker logs db
            exit 1
          fi

          # Verify both databases exist
          echo "Verifying databases..."
          docker exec db mysql -u root -ppassword -e "SHOW DATABASES;" | grep -q "oscar" || { echo "ERROR: oscar database not found"; exit 1; }
          docker exec db mysql -u root -ppassword -e "SHOW DATABASES;" | grep -q "oscar_test" || { echo "ERROR: oscar_test database not found"; exit 1; }
          echo "All databases verified!"

      - name: Start tomcat container
        run: |
          docker run -d --name openo-tomcat-dev \
            --network open-o-network \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/.m2-cache:/root/.m2 \
            -w /workspace \
            openo-tomcat-dev tail -f /dev/null

      - name: Configure git safe directory
        run: |
          docker exec openo-tomcat-dev bash -c "
            git config --global --add safe.directory /workspace
          "

      - name: Run legacy tests
        run: |
          docker exec openo-tomcat-dev bash -c "
            echo '========================================='
            echo 'Running Legacy Tests (JUnit 4 with MariaDB)'
            echo '========================================='
            make install --run-legacy-tests
          "
