name: Notify Issue Reporter on PR Merge
permissions:
  contents: read
  issues: write

on:
  pull_request:
    types: [closed]

jobs:
  notify-reporter:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Check for linked issues
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get the PR body and title
            const prBody = pr.body || '';
            const prTitle = pr.title || '';
            const prText = `${prTitle} ${prBody}`;

            // Find issue references (e.g., fixes #123, closes #456, resolves #789)
            const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s+#(\d+)/gi;
            const matches = [...prText.matchAll(issuePattern)];

            if (matches.length === 0) {
              console.log('No linked issues found in PR');
              return;
            }

            for (const match of matches) {
              const issueNumber = match[1];
              console.log(`Found linked issue: #${issueNumber}`);

              try {
                // Get issue details
                const issue = await github.rest.issues.get({
                  owner,
                  repo,
                  issue_number: issueNumber
                });

                const issueAuthor = issue.data.user.login;
                const prAuthor = pr.user.login;
                const prNumber = pr.number;
                const prUrl = pr.html_url;

                // Create a comment mentioning the issue reporter
                const comment = `## ðŸ”” Fix Deployed Notification

Hey @${issueAuthor}! The pull request #${prNumber} that addresses this issue has been merged.

**What's next?**
- The fix has been merged into the \`${pr.base.ref}\` branch
- Please verify if the issue is resolved once the changes are deployed to your environment
- If the issue persists, please comment here with details

**PR Details:**
- PR: #${prNumber} - ${pr.title}
- Merged by: @${pr.merged_by.login}
- Author: @${prAuthor}

Thank you for reporting this issue! Your feedback helps improve OpenO EMR.

---
*This is an automated message. If you have questions, please comment below.*`;

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: comment
                });

                console.log(`Notified @${issueAuthor} on issue #${issueNumber}`);

                // Add a label to indicate fix is pending verification
                try {
                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    labels: ['status: pending-verification']
                  });
                  console.log(`Added 'status: pending-verification' label to issue #${issueNumber}`);
                } catch (labelError) {
                  console.log(`Could not add label (may not exist): ${labelError.message}`);
                }

              } catch (error) {
                console.error(`Error processing issue #${issueNumber}: ${error.message}`);
              }
            }